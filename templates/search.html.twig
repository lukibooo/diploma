{% extends 'base.html.twig' %}

{% block page_name %}search{% endblock %}
{% block stylesheets %}
  <link rel="stylesheet" href="{{ asset('css/search.css') }}">
{% endblock %}

{% block content %}
<div class="page-container">
    <!-- Sidebar filters -->
    <aside class="sidebar">
        <form action="{{ url('search') }}" method="POST">
            <div class="filter-group reset-group">
                <button type="reset" class="reset-btn">Скинути фільтри ✕</button>
            </div>
            <div class="filter-group">
                <h2>Предмети:</h2>
                <div class="subjects-list">
                    {% for i in 1..3 %}
                        <div class="subject-row">
                            <select name="subject{{ i }}" required>
                                <option value="" disabled selected>Предмет №1</option>
                                {% for subject in subjects %}
                                    <option value="{{ subject }}">{{ subject }}</option>
                                {% endfor %}
                            </select>
                            <input type="number" name="score{{ i }}" placeholder="Бал" min="100" max="200" required>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <div class="filter-group">
                <h2>Місто:</h2>
                <div class="autocomplete-wrapper">
                    <input type="text" name="city" id="city-input" placeholder="Оберіть місто…" autocomplete="off">
                    <div class="autocomplete-list" id="city-list"></div>
                </div>
            </div>

            <div class="filter-group">
                <h2>Спеціальність:</h2>
                <div class="autocomplete-wrapper">
                    <input type="text" name="specialty" id="specialty-input" placeholder="Оберіть спеціальність…"
                           autocomplete="off">
                    <div class="autocomplete-list" id="specialty-list"></div>
                </div>
            </div>

            <div class="filter-group">
                <h2>Ціна:</h2>
                <div class="price-range">
                    <input type="number" name="price_from" placeholder="Від" min="0">
                    <input type="number" name="price_to" placeholder="До" min="0">
                </div>
            </div>

            <div class="filter-group">
                <label>
                    <input type="checkbox" name="military">
                    Військова кафедра
                </label>
            </div>
            <div class="subject-row">
              <select name="subject3">
                <option value="" disabled selected>Предмет №3</option>
                <option>Українська мова</option>
                <option>Математика</option>
                <option>Історія України</option>
                <option>Англійська мова</option>
                <option>Німецька мова</option>
                <option>Французька мова</option>
                <option>Іспанська мова</option>
                <option>Українська література</option>
                <option>Хімія</option>
                <option>Біологія</option>
                <option>Географія</option>
                <option>Фізика</option>
              </select>
              <input type="number" name="score3" placeholder="Бал" min="0" max="200">
            </div>
            <div class="subject-row">
              <select name="subject4">
                <option value="" disabled selected>Предмет №4</option>
                <option>Українська мова</option>
                <option>Математика</option>
                <option>Історія України</option>
                <option>Англійська мова</option>
                <option>Німецька мова</option>
                <option>Французька мова</option>
                <option>Іспанська мова</option>
                <option>Українська література</option>
                <option>Хімія</option>
                <option>Біологія</option>
                <option>Географія</option>
                <option>Фізика</option>
              </select>
              <input type="number" name="score4" placeholder="Бал" min="0" max="200">
            </div>
          </div>
        </div>

        <!-- City -->
        <div class="filter-group">
          <h2>Місто:</h2>
          <input list="cities" name="city" placeholder="Оберіть місто…">
            <datalist id="cities">
            <option>Київ</option>
            <option>Львів</option>
            <option>Одеса</option>
            <option>Дніпро</option>
            <option>Харків</option>
            <option>Суми</option>
            <option>Полтава</option>
            <option>Чернігів</option>
          </datalist>
        </div>

        <!-- Price -->
        <div class="filter-group">
          <h2>Ціна:</h2>
          <div class="price-range">
            <input type="number" name="price_from" placeholder="Від" min="0">
            <input type="number" name="price_to"   placeholder="До" min="0">
          </div>
        </div>

        <!-- Checkbox -->
        <div class="filter-group">
          <label>
            <input type="checkbox" name="military">
            Військова кафедра
          </label>
        </div>
      </form>
    </aside>


    <script>
        function setupAutocomplete(inputId, listId, url) {
            const input = document.getElementById(inputId);
            const list = document.getElementById(listId);

            input.addEventListener('input', function () {
                const query = this.value;
                if (query.length < 2) {
                    list.innerHTML = '';
                    return;
                }

                fetch(url + '?q=' + encodeURIComponent(query))
                    .then(res => res.json())
                    .then(data => {
                        list.innerHTML = '';
                        data.forEach(item => {
                            const div = document.createElement('div');
                            div.textContent = item;
                            div.classList.add('autocomplete-item');
                            div.onclick = () => {
                                input.value = item;
                                list.innerHTML = '';
                            };
                            list.appendChild(div);
                        });
                    });
            });

            document.addEventListener('click', (e) => {
                if (!list.contains(e.target) && e.target !== input) {
                    list.innerHTML = '';
                }
            });
        }

        setupAutocomplete('city-input', 'city-list', '{{ path('autocomplete_cities') }}');
        setupAutocomplete('specialty-input', 'specialty-list', '{{ path('autocomplete_specialties') }}');
    </script>
    <div class="university-results">
        {% if universities is not null %}
            {% if universities is not empty %}
                {% for university in universities %}
                    <div class="university-card">
                        <div class="university-header">
                            <h2 class="univ-name">{{ university.name }}</h2>
                            <span class="star-icon">⭐</span>
                        </div>

                        <div class="university-info">
                            <p><strong>Опис</strong><br>{{ university.description|slice(0, 300) ~ '...' }}</p>
                            <em><a href="#">Детальніше про університет</a></em>
                        </div>

                        {% for specialty in university.specialties %}
                            <div class="university-data">
                                <div class="edu-level">{{ specialty.code }} – {{ specialty.name }}</div>
                                <div class="price">{{ specialty.price }} грн/рік</div>

                                {% for number in specialty.numbers %}
                                    <div class="subject-line">
                                        <span>{{ number.subject.name }}</span>
                                        <span>{{ number.value }}</span>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endfor %}
                    </div>
                {% endfor %}
            {% else %}
                <div class="no-results-block">
                    <img src="/images/no_results.png" alt="Результатів не знайдено" class="no-results-img">
                    <p class="no-results-text">На жаль, ми не знайшли жодного результату за вашими фільтрами.<br>Спробуйте змінити умови пошуку.</p>
                </div>
            {% endif %}
        {% endif %}
    </div>
</div>
{% endblock %}
